---
title: ç¬¬35æœŸ
date: '2021-04-15'
tags: ['èµ„è®¯']
draft: false
---

<TOCInline toc={props.toc} asDisclosure toHeading={3} />

## 2021/04/15

## æ¯å‘¨èµ„è®¯ - ç¬¬`35`æœŸ

### 1. [ã€Œæºç è§£æ ã€è¿™ä¸€æ¬¡å½»åº•å¼„æ‡‚ react-router è·¯ç”±åŸç†](https://juejin.cn/post/6886290490640039943)

#### ä¸€ã€æ­£ç¡®ç†è§£`react-router`

##### å•é¡µé¢åº”ç”¨

å•é¡µé¢åº”ç”¨æ˜¯ä½¿ç”¨ä¸€ä¸ª`html`ä¸‹ï¼Œä¸€æ¬¡æ€§åŠ è½½`js`, `css`ç­‰èµ„æºï¼Œæ‰€æœ‰é¡µé¢éƒ½åœ¨ä¸€ä¸ªå®¹å™¨é¡µé¢ä¸‹ï¼Œé¡µé¢åˆ‡æ¢å®è´¨æ˜¯ç»„ä»¶çš„åˆ‡æ¢

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8a08f0155b494fd7bb3bdcb12104c060~tplv-k3u1fbpfcp-watermark.image)

##### æ­£ç¡®ç†è§£`react-router`

###### `react-router-dom`å’Œ`react-router`å’Œ`history`åº“ä¸‰è€…ä»€ä¹ˆå…³ç³»

- history
  - å¯ä»¥ç†è§£ä¸º`react-router`çš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯æ•´ä¸ªè·¯ç”±åŸç†çš„æ ¸å¿ƒ
  - é‡Œé¢é›†æˆäº†`popState`ã€`history.pushState`ç­‰åº•å±‚è·¯ç”±å®ç°çš„åŸç†æ–¹æ³•
- react-router
  - å¯ä»¥ç†è§£ä¸ºæ˜¯`react-router-dom`çš„æ ¸å¿ƒ
  - é‡Œé¢å°è£…äº†`Router`ã€`Route`ã€`Switch`ç­‰æ ¸å¿ƒç»„ä»¶
  - å®ç°äº†ä»è·¯ç”±çš„æ”¹å˜åˆ°ç»„ä»¶çš„æ›´æ–°çš„æ ¸å¿ƒåŠŸèƒ½,åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­åªè¦ä¸€æ¬¡æ€§å¼•å…¥`react-router-dom`å°±å¯ä»¥äº†
- react-router-dom
  - åœ¨`react-router`çš„æ ¸å¿ƒåŸºç¡€ä¸Šï¼Œæ·»åŠ äº†ç”¨äºè·³è½¬çš„`Link`ç»„ä»¶ï¼Œå’Œ`histoy`æ¨¡å¼ä¸‹çš„`BrowserRouter`å’Œ`hash`æ¨¡å¼ä¸‹çš„`HashRouterç»„ä»¶ç­‰`ã€‚
  - æ‰€è°“`BrowserRouter`å’Œ`HashRouter`ï¼Œä¹Ÿåªä¸è¿‡ç”¨äº†`history`åº“ä¸­`createBrowserHistory`å’Œ`createHashHistory`æ–¹æ³•

```jsx
import { BrowserRouter as Router, Switch, Route, Redirect, Link } from 'react-router-dom'

import Detail from '../src/page/detail'
import List from '../src/page/list'
import Index from '../src/page/home/index'

const menusList = [
  {
    name: 'é¦–é¡µ',
    path: '/index',
  },
  {
    name: 'åˆ—è¡¨',
    path: '/list',
  },
  {
    name: 'è¯¦æƒ…',
    path: '/detail',
  },
]
const index = () => {
  return (
    <div>
      <div>
        <Router>
          <div>
            {menusList.map((router) => (
              <Link key={router.path} to={router.path}>
                <span className="routerLink">{router.name}</span>
              </Link>
            ))}
          </div>
          <Switch>
            <Route path={'/index'} component={Index} />
            <Route path={'/list'} component={List} />
            <Route path={'/detail'} component={Detail} />
            {/*  è·¯ç”±ä¸åŒ¹é…ï¼Œé‡å®šå‘åˆ°/index  */}
            <Redirect from="/*" to="/index" />
          </Switch>
        </Router>
      </div>
    </div>
  )
}
```

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3eac570169a4480598001f601ef374d5~tplv-k3u1fbpfcp-watermark.image)

##### å•é¡µé¢å®ç°æ ¸å¿ƒåŸç†

å•é¡µé¢åº”ç”¨è·¯ç”±å®ç°åŸç†æ˜¯ï¼Œåˆ‡æ¢`url`ï¼Œç›‘å¬`url`å˜åŒ–ï¼Œä»è€Œæ¸²æŸ“ä¸åŒçš„é¡µé¢ç»„ä»¶ã€‚

ä¸»è¦çš„æ–¹å¼æœ‰`history`æ¨¡å¼å’Œ`hash`æ¨¡å¼ã€‚

#### äºŒã€å•é¡µé¢å®ç°åŸç†

##### 1. `history`æ¨¡å¼åŸç†

a. æ”¹å˜è·¯ç”±

###### `history.pushState`

```js
history.pushState(state, title, path)
```

- `state`: ä¸€ä¸ªä¸æŒ‡å®šç½‘å€ç›¸å…³çš„çŠ¶æ€å¯¹è±¡ï¼Œ`popstate`äº‹ä»¶è§¦å‘æ—¶ï¼Œè¯¥å¯¹è±¡ä¼šä¼ å…¥å›è°ƒå‡½æ•°ã€‚å¦‚æœä¸éœ€è¦å¯å¡«`null`
- `title`ï¼šæ–°é¡µé¢çš„æ ‡é¢˜ï¼Œä½†æ˜¯æ‰€æœ‰æµè§ˆå™¨ç›®å‰éƒ½å¿½ç•¥è¿™ä¸ªå€¼ï¼Œå¯å¡«`null`
- `path`ï¼šæ–°çš„ç½‘å€ï¼Œå¿…é¡»ä¸å½“å‰é¡µé¢å¤„åœ¨åŒä¸€ä¸ªåŸŸã€‚æµè§ˆå™¨çš„åœ°å€æ å°†æ˜¾ç¤ºè¿™ä¸ªåœ°å€

###### `history.replaceState`

```js
history.replaceState(state, title, path)
```

å‚æ•°å’Œ`pushState`ä¸€æ ·ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šä¿®æ”¹å½“å‰çš„`history`å¯¹è±¡è®°å½•ï¼Œ `history.length`çš„é•¿åº¦ä¸ä¼šæ”¹å˜ã€‚

b. ç›‘å¬è·¯ç”±

###### `popstate`äº‹ä»¶

```js
window.addEventListener('popstate', function (e) {
  /* ç›‘å¬æ”¹å˜ */
})
```

åŒä¸€ä¸ªæ–‡æ¡£çš„`history`å¯¹è±¡å‡ºç°å˜åŒ–æ—¶ï¼Œå°±ä¼šè§¦å‘`popstate`äº‹ä»¶

- `history.pushState`å¯ä»¥ä½¿æµè§ˆå™¨åœ°å€æ”¹å˜ï¼Œä½†æ˜¯æ— éœ€åˆ·æ–°é¡µé¢ã€‚
- æ³¨æ„ âš ï¸ çš„æ˜¯ï¼šç”¨`history.pushState()`æˆ–è€…`history.replaceState()`ä¸ä¼šè§¦å‘`popstate`äº‹ä»¶ã€‚
- `popstate`äº‹ä»¶åªä¼šåœ¨æµè§ˆå™¨æŸäº›è¡Œä¸ºä¸‹è§¦å‘, æ¯”å¦‚
  - åé€€æŒ‰é’®
  - å‰è¿›æŒ‰é’®
  - `history.back()`
  - `history.forward()`
  - `history.go()`

##### 2. `hash`æ¨¡å¼åŸç†

a. æ”¹å˜è·¯ç”±

###### `window.location.hash`

é€šè¿‡`window.location.hash`å±æ€§è·å–å’Œè®¾ç½®`hash`å€¼ã€‚

b. ç›‘å¬è·¯ç”±

###### `onhashchange`

```js
window.addEventListener('hashchange', function (e) {
  /* ç›‘å¬æ”¹å˜ */
})
```

#### ä¸‰ã€ç†è§£`history`åº“

`react-router`è·¯ç”±ç¦»ä¸å¼€`history`åº“ï¼Œ`history`ä¸“æ³¨äºè®°å½•è·¯ç”± history çŠ¶æ€ï¼Œä»¥åŠ`path`æ”¹å˜äº†ï¼Œæˆ‘ä»¬åº”è¯¥**åšäº›ä»€ä¹ˆ**

- åœ¨`history`æ¨¡å¼ä¸‹ç”¨`popstate`ç›‘å¬è·¯ç”±å˜åŒ–
- åœ¨`hash`æ¨¡å¼ä¸‹ç”¨`hashchange`ç›‘å¬è·¯ç”±çš„å˜åŒ–ã€‚

##### `createBrowserHistory`

`Browser`æ¨¡å¼ä¸‹è·¯ç”±çš„è¿è¡Œ ï¼Œä¸€åˆ‡éƒ½ä»`createBrowserHistory`å¼€å§‹ã€‚è¿™é‡Œæˆ‘ä»¬å‚è€ƒçš„`history-4.7.2`ç‰ˆæœ¬ï¼Œæœ€æ–°ç‰ˆæœ¬ä¸­`api`å¯èƒ½æœ‰äº›å‡ºå…¥ï¼Œä½†æ˜¯åŸç†éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåœ¨è§£æ`history`è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨`setState`ã€`push`ã€`handlePopState`ã€`listen`æ–¹æ³•

```js
const PopStateEvent = 'popstate'
const HashChangeEvent = 'hashchange'
/* è¿™é‡Œç®€åŒ–äº†createBrowserHistoryï¼Œåˆ—å‡ºäº†å‡ ä¸ªæ ¸å¿ƒapiåŠå…¶ä½œç”¨ */
function createBrowserHistory() {
  /* å…¨å±€history  */
  const globalHistory = window.history
  /* å¤„ç†è·¯ç”±è½¬æ¢ï¼Œè®°å½•äº†listensä¿¡æ¯ã€‚ */
  const transitionManager = createTransitionManager()
  /* æ”¹å˜locationå¯¹è±¡ï¼Œé€šçŸ¥ç»„ä»¶æ›´æ–° */
  const setState = () => {
    /* ... */
  }

  /* å¤„ç†å½“pathæ”¹å˜åï¼Œå¤„ç†popstateå˜åŒ–çš„å›è°ƒå‡½æ•° */
  const handlePopState = () => {
    /* ... */
  }

  /* history.pushæ–¹æ³•ï¼Œæ”¹å˜è·¯ç”±ï¼Œé€šè¿‡å…¨å±€å¯¹è±¡history.pushStateæ”¹å˜url, é€šçŸ¥routerè§¦å‘æ›´æ–°ï¼Œæ›¿æ¢ç»„ä»¶ */
  const push = () => {
    /*...*/
  }

  /* åº•å±‚åº”ç”¨äº‹ä»¶ç›‘å¬å™¨ï¼Œç›‘å¬popstateäº‹ä»¶ */
  const listen = () => {
    /*...*/
  }
  return {
    push,
    listen,
    /* .... */
  }
}
```

ä¸‹é¢é€ä¸€åˆ†æå„ä¸ª`api`, å’Œä»–ä»¬ä¹‹å‰çš„ç›¸äº’ä½œç”¨

```js
const PopStateEvent = 'popstate'
const HashChangeEvent = 'hashchange'
```

`popstate`å’Œ`hashchange`æ˜¯ç›‘å¬è·¯ç”±å˜åŒ–åº•å±‚æ–¹æ³•ã€‚

###### 1. `setState`

```jsx
const setState = (nextState) => {
  /* åˆå¹¶ä¿¡æ¯ */
  Object.assign(history, nextState)
  history.length = globalHistory.length
  /* é€šçŸ¥æ¯ä¸€ä¸ªlistens è·¯ç”±å·²ç»å‘ç”Ÿå˜åŒ– */
  transitionManager.notifyListeners(history.location, history.action)
}
```

ä»£ç å¾ˆç®€å•ï¼šç»Ÿä¸€æ¯ä¸ª`transitionManager`ç®¡ç†çš„`listener`è·¯ç”±çŠ¶æ€å·²ç»æ›´æ–°ã€‚

ä»€ä¹ˆæ—¶å€™ç»‘å®š`litener`ï¼Œ æˆ‘ä»¬åœ¨æ¥ä¸‹æ¥çš„`React-Router`ä»£ç ä¸­ä¼šä»‹ç»ã€‚

###### 2. `listen`

```js
const listen = (listener) => {
  /* æ·»åŠ listen */
  const unlisten = transitionManager.appendListener(listener)
  checkDOMListeners(1)

  return () => {
    checkDOMListeners(-1)
    unlisten()
  }
}
```

###### _`checkDOMListeners`_

```js
const checkDOMListeners = (delta) => {
  listenerCount += delta
  if (listenerCount === 1) {
    addEventListener(window, PopStateEvent, handlePopState)
    if (needsHashChangeListener) {
      addEventListener(window, HashChangeEvent, handleHashChange)
    }
  } else if (listenerCount === 0) {
    removeEventListener(window, PopStateEvent, handlePopState)
    if (needsHashChangeListener) {
      removeEventListener(window, HashChangeEvent, handleHashChange)
    }
  }
}
```

`listen`æœ¬è´¨é€šè¿‡`checkDOMListeners`çš„å‚æ•°`1`æˆ–`-1`æ¥ç»‘å®š/è§£ç»‘`popstate`äº‹ä»¶ï¼Œå½“è·¯ç”±å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œè°ƒç”¨å¤„ç†å‡½æ•°`handlePopState`ã€‚

###### 3. `push`

```jsx
const push = (path, state) => {
  const action = 'PUSH'
  /* 1 åˆ›å»ºlocationå¯¹è±¡ */
  const location = createLocation(path, state, createKey(), history.location)
  /* ç¡®å®šæ˜¯å¦èƒ½è¿›è¡Œè·¯ç”±è½¬æ¢ï¼Œè¿˜åœ¨ç¡®è®¤çš„æ—¶å€™åˆå¼€å§‹äº†å¦ä¸€ä¸ªè½¬å˜ ,å¯èƒ½ä¼šé€ æˆå¼‚å¸¸ */
  transitionManager.confirmTransitionTo(location, action, getUserConfirmation, (ok) => {
    if (!ok) {
      return
    }
    const href = createHref(location)
    const { key, state } = location
    if (canUseHistory) {
      /* æ”¹å˜ url */
      globalHistory.pushState({ key, state }, null, href)
      if (forceRefresh) {
        window.location.href = href
      } else {
        /* æ”¹å˜ react-router locationå¯¹è±¡, åˆ›å»ºæ›´æ–°ç¯å¢ƒ */
        setState({ action, location })
      }
    } else {
      window.location.href = href
    }
  })
}
```

`push(history.push)`æµç¨‹å¤§è‡´æ˜¯

- é¦–å…ˆç”Ÿæˆä¸€ä¸ªæœ€æ–°çš„`location`å¯¹è±¡
- ç„¶åé€šè¿‡`window.history.pushState`æ–¹æ³•æ”¹å˜æµè§ˆå™¨å½“å‰è·¯ç”±(å³å½“å‰çš„`path`)
- æœ€åé€šè¿‡`setState`æ–¹æ³•é€šçŸ¥`React-Router`æ›´æ–°ï¼Œå¹¶ä¼ é€’å½“å‰çš„`location`å¯¹è±¡

ç”±äºè¿™æ¬¡`url`å˜åŒ–çš„ï¼Œæ˜¯`history.pushState`äº§ç”Ÿçš„ï¼Œå¹¶ä¸ä¼šè§¦å‘`popState`æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨`setState`ï¼Œè§¦å‘ç»„ä»¶æ›´æ–°ã€‚

###### 4. `handlePopState`

æœ€åæˆ‘ä»¬æ¥çœ‹çœ‹å½“`popState`ç›‘å¬çš„å‡½æ•°ï¼Œå½“`path`æ”¹å˜çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆ

```js
/* æˆ‘ä»¬ç®€åŒ–ä¸€ä¸‹handlePopState */
const handlePopState = (event) => {
  /* è·å–å½“å‰locationå¯¹è±¡ */
  const location = getDOMLocation(event.state)
  const action = 'POP'

  transitionManager.confirmTransitionTo(location, action, getUserConfirmation, (ok) => {
    if (ok) {
      setState({ action, location })
    } else {
      revertPop(location)
    }
  })
}
```

`handlePopState`ä»£ç å¾ˆç®€å• ï¼Œåˆ¤æ–­ä¸€ä¸‹`action`ç±»å‹ä¸º`pop`,ç„¶å`setState` ï¼Œä»æ–°åŠ è½½ç»„ä»¶ã€‚

##### `createHashHistory`

`hash`æ¨¡å¼å’Œ`history API`ç±»ä¼¼ï¼Œæˆ‘ä»¬é‡ç‚¹è®²ä¸€ä¸‹`hash`æ¨¡å¼ä¸‹ï¼Œæ€ä¹ˆç›‘å¬è·¯ç”±ï¼Œå’Œ`push`, `replace`æ–¹æ³•æ˜¯æ€ä¹ˆæ”¹å˜æ”¹å˜è·¯å¾„çš„ã€‚

###### ç›‘å¬å“ˆå¸Œè·¯ç”±å˜åŒ–

```js
const HashChangeEvent = 'hashchange'
const checkDOMListeners = (delta) => {
  listenerCount += delta
  if (listenerCount === 1) {
    addEventListener(window, HashChangeEvent, handleHashChange)
  } else if (listenerCount === 0) {
    removeEventListener(window, HashChangeEvent, handleHashChange)
  }
}
```

å’Œä¹‹å‰æ‰€è¯´çš„ä¸€æ ·ï¼Œå°±æ˜¯ç”¨`hashchange`æ¥ç›‘å¬`hash`è·¯ç”±çš„å˜åŒ–ã€‚

###### æ”¹å˜å“ˆå¸Œè·¯ç”±

```js
/* å¯¹åº” push æ–¹æ³• */
const pushHashPath = (path) => (window.location.hash = path)

/* å¯¹åº”replaceæ–¹æ³• */
const replaceHashPath = (path) => {
  const hashIndex = window.location.href.indexOf('#')

  window.location.replace(
    window.location.href.slice(0, hashIndex >= 0 ? hashIndex : 0) + '#' + path
  )
}
```

åœ¨`hash`æ¨¡å¼ä¸‹ ï¼Œ`history.push`åº•å±‚æ˜¯è°ƒç”¨äº†`window.location.href`æ¥æ”¹å˜è·¯ç”±ã€‚`history.replace`åº•å±‚æ˜¯æ‰ç”¨`window.location.replace`æ”¹å˜è·¯ç”±ã€‚

##### æ€»ç»“

æˆ‘ä»¬ç”¨ä¸€å¹…å›¾æ¥æè¿°äº†ä¸€ä¸‹`history`åº“æ•´ä½“æµç¨‹ã€‚
![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ac7ed7a701714650b55c9193db2220ea~tplv-k3u1fbpfcp-watermark.image)

#### å››ã€æ ¸å¿ƒ api

##### 1. `Router` - æ¥æ”¶`location`å˜åŒ–ï¼Œæ´¾å‘æ›´æ–°æµ

`Router`ä½œç”¨æ˜¯æŠŠ`history location`ç­‰è·¯ç”±ä¿¡æ¯ä¼ é€’ä¸‹å»

```jsx
/* Router ä½œç”¨æ˜¯æŠŠ history location ç­‰è·¯ç”±ä¿¡æ¯ ä¼ é€’ä¸‹å»  */
class Router extends React.Component {
  static computeRootMatch(pathname) {
    return { path: '/', url: '/', params: {}, isExact: pathname === '/' }
  }
  constructor(props) {
    super(props)
    this.state = {
      location: props.history.location,
    }
    //è®°å½•pendingä½ç½®
    //å¦‚æœå­˜åœ¨ä»»ä½•<Redirect>ï¼Œåˆ™åœ¨æ„é€ å‡½æ•°ä¸­è¿›è¡Œæ›´æ”¹
    //åœ¨åˆå§‹æ¸²æŸ“æ—¶ã€‚å¦‚æœæœ‰ï¼Œå®ƒä»¬å°†åœ¨
    //åœ¨å­ç»„ä»¶èº«ä¸Šæ¿€æ´»ï¼Œæˆ‘ä»¬å¯èƒ½ä¼š
    //åœ¨å®‰è£…<Router>ä¹‹å‰è·å–ä¸€ä¸ªæ–°ä½ç½®ã€‚
    this._isMounted = false
    this._pendingLocation = null
    /* æ­¤æ—¶çš„historyï¼Œæ˜¯historyåˆ›å»ºçš„historyå¯¹è±¡ */
    if (!props.staticContext) {
      /* è¿™é‡Œåˆ¤æ–­ componentDidMount å’Œ history.listen æ‰§è¡Œé¡ºåº ç„¶åæŠŠ locationå¤åˆ¶ ï¼Œé˜²æ­¢ç»„ä»¶é‡æ–°æ¸²æŸ“ */
      this.unlisten = props.history.listen((location) => {
        /* åˆ›å»ºç›‘å¬è€… */
        if (this._isMounted) {
          this.setState({ location })
        } else {
          this._pendingLocation = location
        }
      })
    }
  }
  componentDidMount() {
    this._isMounted = true
    if (this._pendingLocation) {
      this.setState({ location: this._pendingLocation })
    }
  }
  componentWillUnmount() {
    /* è§£é™¤ç›‘å¬ */
    if (this.unlisten) this.unlisten()
  }
  render() {
    return (
      /*  è¿™é‡Œå¯ä»¥ç†è§£ react.createContext åˆ›å»ºä¸€ä¸ª contextä¸Šä¸‹æ–‡ ï¼Œä¿å­˜routeråŸºæœ¬ä¿¡æ¯ã€‚children */
      <RouterContext.Provider
        children={this.props.children || null}
        value={{
          history: this.props.history,
          location: this.state.location,
          match: Router.computeRootMatch(this.state.location.pathname),
          staticContext: this.props.staticContext,
        }}
      />
    )
  }
}
```

æ€»ç»“ï¼š

- åˆå§‹åŒ–ç»‘å®š`listen`, è·¯ç”±å˜åŒ–, é€šçŸ¥æ”¹å˜`location`, æ”¹å˜ç»„ä»¶ã€‚
- `react`çš„`history`è·¯ç”±çŠ¶æ€æ˜¯ä¿å­˜åœ¨`React.Content`ä¸Šä¸‹æ–‡ä¹‹é—´, çŠ¶æ€æ›´æ–°ã€‚
- ä¸€ä¸ªé¡¹ç›®åº”è¯¥æœ‰ä¸€ä¸ªæ ¹`Router`ï¼Œæ¥äº§ç”Ÿåˆ‡æ¢è·¯ç”±ç»„ä»¶ä¹‹å‰çš„æ›´æ–°ä½œç”¨ã€‚
  å¦‚æœå­˜åœ¨å¤šä¸ª`Router`ä¼šé€ æˆï¼Œä¼šé€ æˆåˆ‡æ¢è·¯ç”±ï¼Œé¡µé¢ä¸æ›´æ–°çš„æƒ…å†µã€‚

##### 2. `Switch` - åŒ¹é…æ­£ç¡®çš„å”¯ä¸€çš„è·¯ç”±

æ ¹æ®`router`æ›´æ–°æµï¼Œæ¥æ¸²æŸ“å½“å‰ç»„ä»¶ã€‚

```js
/* switchç»„ä»¶ */
class Switch extends React.Component {
  render() {
    return (
      <RouterContext.Consumer>
        {/* å«æœ‰ history location å¯¹è±¡çš„ context */}
        {(context) => {
          invariant(context, 'You should not use <Switch> outside a <Router>')
          const location = this.props.location || context.location
          let element, match
          //æˆ‘ä»¬ä½¿ç”¨React.Children.forEachè€Œä¸æ˜¯React.Children.toArrayï¼ˆï¼‰.findï¼ˆï¼‰
          //è¿™é‡Œæ˜¯å› ä¸ºtoArrayå‘æ‰€æœ‰å­å…ƒç´ æ·»åŠ äº†é”®ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›
          //ä¸ºå‘ˆç°ç›¸åŒçš„ä¸¤ä¸ª<Route>sè§¦å‘å¸è½½/é‡æ–°è£…è½½
          //ç»„ä»¶ä½äºä¸åŒçš„URLã€‚
          //è¿™é‡Œåªéœ€ç„¶ç¬¬ä¸€ä¸ª å«æœ‰ match === null çš„ç»„ä»¶
          React.Children.forEach(this.props.children, (child) => {
            if (match == null && React.isValidElement(child)) {
              element = child
              // å­ç»„ä»¶ ä¹Ÿå°±æ˜¯ è·å– Routeä¸­çš„ path æˆ–è€… rediect çš„ from
              const path = child.props.path || child.props.from
              match = path ? matchPath(location.pathname, { ...child.props, path }) : context.match
            }
          })
          return match ? React.cloneElement(element, { location, computedMatch: match }) : null
        }}
      </RouterContext.Consumer>
    )
  }
}
```

- æ‰¾åˆ°ä¸å½“å‰`path`, åŒ¹é…çš„ç»„ä»¶è¿›è¡Œæ¸²æŸ“ã€‚
- é€šè¿‡`pathname`å’Œç»„ä»¶çš„`path`è¿›è¡ŒåŒ¹é…ã€‚
- æ‰¾åˆ°ç¬¦åˆ`path`çš„`router`ç»„ä»¶ã€‚

###### `matchPath`

```jsx
function matchPath(pathname, options = {}) {
  if (typeof options === 'string' || Array.isArray(options)) {
    options = { path: options }
  }

  const { path, exact = false, strict = false, sensitive = false } = options

  const paths = [].concat(path)

  return paths.reduce((matched, path) => {
    if (!path && path !== '') return null
    if (matched) return matched

    const { regexp, keys } = compilePath(path, {
      end: exact,
      strict,
      sensitive,
    })
    const match = regexp.exec(pathname)
    /* åŒ¹é…ä¸æˆåŠŸï¼Œè¿”å›null */
    if (!match) return null

    const [url, ...values] = match
    const isExact = pathname === url

    if (exact && !isExact) return null

    return {
      path, // the path used to match
      url: path === '/' && url === '' ? '/' : url, // the matched portion of the URL
      isExact, // whether or not we matched exactly
      params: keys.reduce((memo, key, index) => {
        memo[key.name] = values[index]
        return memo
      }, {}),
    }
  }, null)
}
```

åŒ¹é…ç¬¦åˆçš„è·¯ç”±ã€‚

##### 3. `Route` - ç»„ä»¶é¡µé¢æ‰¿è½½å®¹å™¨

```jsx
/**
 * The public API for matching a single path and rendering.
 */
class Route extends React.Component {
  render() {
    return (
      <RouterContext.Consumer>
        {(context) => {
          /* router / route ä¼šç»™äºˆè­¦å‘Šè­¦å‘Š */
          invariant(context, 'You should not use <Route> outside a <Router>')
          // computedMatch ä¸º ç»è¿‡ swichå¤„ç†åçš„ path
          const location = this.props.location || context.location
          const match = this.props.computedMatch
            ? this.props.computedMatch // <Switch> already computed the match for us
            : this.props.path
            ? matchPath(location.pathname, this.props)
            : context.match
          const props = { ...context, location, match }
          let { children, component, render } = this.props

          if (Array.isArray(children) && children.length === 0) {
            children = null
          }

          return (
            <RouterContext.Provider value={props}>
              {props.match
                ? children
                  ? typeof children === 'function'
                    ? __DEV__
                      ? evalChildrenDev(children, props, this.props.path)
                      : children(props)
                    : children
                  : component
                  ? React.createElement(component, props)
                  : render
                  ? render(props)
                  : null
                : typeof children === 'function'
                ? __DEV__
                  ? evalChildrenDev(children, props, this.props.path)
                  : children(props)
                : null}
            </RouterContext.Provider>
          )
        }}
      </RouterContext.Consumer>
    )
  }
}
```

- åŒ¹é…`path`, æ¸²æŸ“ç»„ä»¶ã€‚
- ä½œä¸ºè·¯ç”±ç»„ä»¶çš„å®¹å™¨, å¯ä»¥æ ¹æ®å°†å®é™…çš„ç»„ä»¶æ¸²æŸ“å‡ºæ¥ã€‚
- é€šè¿‡`RouterContext.Consume`å–å‡ºå½“å‰ä¸Šä¸€çº§çš„`location`, `match`ç­‰ä¿¡æ¯ã€‚
- ä½œä¸º`prop`ä¼ é€’ç»™é¡µé¢ç»„ä»¶ã€‚ä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨é¡µé¢ç»„ä»¶ä¸­çš„`props`ä¸­è·å–`location`, `match`ç­‰ä¿¡æ¯ã€‚

##### 4. `Redirect` - æ²¡æœ‰ç¬¦åˆçš„è·¯ç”±ï¼Œé‚£ä¹ˆé‡å®šå‘

é‡å®šå‘ç»„ä»¶ï¼Œ å¦‚æœæ¥è·¯ç”±åŒ¹é…ä¸Šï¼Œä¼šé‡å®šå‘å¯¹åº”çš„è·¯ç”±ã€‚

```jsx
function Redirect({ computedMatch, to, push = false }) {
  return (
    <RouterContext.Consumer>
      {(context) => {
        const { history, staticContext } = context
        /* methodå°±æ˜¯è·¯ç”±è·³è½¬æ–¹æ³•ã€‚ */
        const method = push ? history.push : history.replace
        /* æ‰¾åˆ°ç¬¦åˆmatchçš„location ï¼Œæ ¼å¼åŒ–location */
        const location = createLocation(
          computedMatch
            ? typeof to === 'string'
              ? generatePath(to, computedMatch.params)
              : {
                  ...to,
                  pathname: generatePath(to.pathname, computedMatch.params),
                }
            : to
        )
        /* åˆå§‹åŒ–çš„æ—¶å€™è¿›è¡Œè·¯ç”±è·³è½¬ï¼Œå½“åˆå§‹åŒ–çš„æ—¶å€™ï¼Œmountedæ‰§è¡Œpushæ–¹æ³•ï¼Œå½“ç»„ä»¶æ›´æ–°çš„æ—¶å€™ï¼Œå¦‚æœlocationä¸ç›¸ç­‰ã€‚åŒæ ·ä¼šæ‰§è¡Œhistoryæ–¹æ³•é‡å®šå‘ */
        return (
          <Lifecycle
            onMount={() => {
              method(location)
            }}
            onUpdate={(self, prevProps) => {
              const prevLocation = createLocation(prevProps.to)
              if (
                !locationsAreEqual(prevLocation, {
                  ...location,
                  key: prevLocation.key,
                })
              ) {
                method(location)
              }
            }}
            to={to}
          />
        )
      }}
    </RouterContext.Consumer>
  )
}
```

åˆå§‹åŒ–çš„æ—¶å€™è¿›è¡Œè·¯ç”±è·³è½¬ï¼Œå½“åˆå§‹åŒ–çš„æ—¶å€™ï¼Œ`mounted`æ‰§è¡Œ`push`æ–¹æ³•ï¼Œå½“ç»„ä»¶æ›´æ–°çš„æ—¶å€™ï¼Œå¦‚æœ`location`ä¸ç›¸ç­‰ã€‚åŒæ ·ä¼šæ‰§è¡Œ`history`æ–¹æ³•é‡å®šå‘

#### äº”ã€æ€»ç»“ + æµç¨‹åˆ†æ

##### æ€»ç»“

- `history`æä¾›äº†æ ¸å¿ƒ`api`ï¼Œå¦‚ç›‘å¬è·¯ç”±ï¼Œæ›´æ”¹è·¯ç”±çš„æ–¹æ³•ï¼Œå·²ç»ä¿å­˜è·¯ç”±çŠ¶æ€`state`ã€‚
- `react-router`æä¾›è·¯ç”±æ¸²æŸ“ç»„ä»¶ï¼Œè·¯ç”±å”¯ä¸€æ€§åŒ¹é…ç»„ä»¶ï¼Œé‡å®šå‘ç»„ä»¶ç­‰åŠŸèƒ½ç»„ä»¶ã€‚

#### æµç¨‹åˆ†æ

##### å½“åœ°å€æ æ”¹å˜`url`ï¼Œç»„ä»¶çš„æ›´æ–°æ¸²æŸ“éƒ½ç»å†äº†ä»€ä¹ˆï¼ŸğŸ˜ŠğŸ˜ŠğŸ˜Š

> æ‹¿`history`æ¨¡å¼åšå‚è€ƒã€‚

- å½“`url`æ”¹å˜ï¼Œé¦–å…ˆè§¦å‘`histoy`ï¼Œè°ƒç”¨äº‹ä»¶ç›‘å¬`popstate`äº‹ä»¶ï¼Œ
- è§¦å‘å›è°ƒå‡½æ•°`handlePopState`ï¼Œè§¦å‘`history`ä¸‹é¢çš„`setstate`æ–¹æ³•ï¼Œäº§ç”Ÿæ–°çš„`location`å¯¹è±¡ï¼Œ
- ç„¶åé€šçŸ¥`Router`ç»„ä»¶æ›´æ–°`location`å¹¶é€šè¿‡`context`ä¸Šä¸‹æ–‡ä¼ é€’ï¼Œ
- `switch`é€šè¿‡ä¼ é€’çš„æ›´æ–°æµï¼ŒåŒ¹é…å‡ºç¬¦åˆçš„`Route`ç»„ä»¶æ¸²æŸ“ï¼Œ
- æœ€åæœ‰`Route`ç»„ä»¶å–å‡º`context`å†…å®¹ï¼Œä¼ é€’ç»™æ¸²æŸ“é¡µé¢ï¼Œæ¸²æŸ“æ›´æ–°ã€‚

##### å½“æˆ‘ä»¬è°ƒç”¨`history.push`æ–¹æ³•ï¼Œåˆ‡æ¢è·¯ç”±ï¼Œç»„ä»¶çš„æ›´æ–°æ¸²æŸ“åˆéƒ½ç»å†äº†ä»€ä¹ˆå‘¢ï¼Ÿ

> æˆ‘ä»¬è¿˜æ˜¯æ‹¿`history`æ¨¡å¼ä½œä¸ºå‚è€ƒ

- å½“æˆ‘ä»¬è°ƒç”¨`history.push`æ–¹æ³•ï¼Œé¦–å…ˆè°ƒç”¨`history`çš„`push`æ–¹æ³•ï¼Œ
- é€šè¿‡`history.pushState`æ¥æ”¹å˜å½“å‰`url`ï¼Œ
- æ¥ä¸‹æ¥è§¦å‘`history`ä¸‹é¢çš„`setState`æ–¹æ³•ï¼Œ
- æ¥ä¸‹æ¥çš„æ­¥éª¤å°±å’Œä¸Šé¢ä¸€æ¨¡ä¸€æ ·äº†ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€è¯´äº†ã€‚

æˆ‘ä»¬ç”¨ä¸€å¹…å›¾æ¥è¡¨ç¤ºå„ä¸ªè·¯ç”±ç»„ä»¶ä¹‹é—´çš„å…³ç³»
![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e5de251f8dc649e3ae1b1fcf382330ee~tplv-k3u1fbpfcp-watermark.image)

å¸Œæœ›è¯»è¿‡æ­¤ç¯‡æ–‡ç« çš„æœ‹å‹ï¼Œèƒ½å¤Ÿæ˜ç™½`react-router`çš„æ•´ä¸ªæµç¨‹ï¼Œä»£ç é€»è¾‘ä¸æ˜¯å¾ˆéš¾ç†è§£ã€‚æ•´ä¸ªæµç¨‹æˆ‘ç»™å¤§å®¶åˆ†æäº†ä¸€éï¼Œå¸Œæœ›åŒå­¦ä»¬èƒ½ä¸»åŠ¨çœ‹ä¸€æ³¢æºç ï¼ŒæŠŠæ•´ä¸ªæµç¨‹ææ˜ç™½ã€‚çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…,ç»çŸ¥æ­¤äº‹è¦èº¬è¡Œ

#### æ¥æº

- [ã€Œæºç è§£æ ã€è¿™ä¸€æ¬¡å½»åº•å¼„æ‡‚ react-router è·¯ç”±åŸç†](https://juejin.cn/post/6886290490640039943)

### 2. [ç¨‹åºå‘˜åº”è¯¥çŸ¥é“çš„ 3 ä¸ªæ’ç‰ˆåŸåˆ™](https://mp.weixin.qq.com/s/9RotXR2VyBtCNhD5borBrw)

ä½œä¸ºä¸€åå‰ç«¯å¼€å‘äººå‘˜ï¼Œè™½ç„¶ä¸è¦æ±‚æœ‰é«˜è¶…çš„`UI`è®¾è®¡æŠ€å·§ï¼Œä½†æ’ç‰ˆè‡³å°‘è¦çœ‹ç€èˆ’æœã€‚æ‰€ä»¥ï¼Œåˆç†çš„æ’ç‰ˆä¹Ÿæ˜¯å‰ç«¯è¯¥æŒæ¡çš„åŸºæœ¬æŠ€èƒ½ä¹‹ä¸€ã€‚æ’ç‰ˆè¿œè¿œæ²¡æœ‰å¤§å®¶æƒ³çš„é‚£ä¹ˆéš¾ä»¥æŒæ¡ï¼Œç›¸åï¼Œåªè¦æŒæ¡å‡ ä¸ªåŸåˆ™ï¼Œå°±ä¼šè®©ä½ æ’ç‰ˆæé«˜ä¸€ä¸ªæ¡£æ¬¡ã€‚

#### æ¥æº

- [ç¨‹åºå‘˜åº”è¯¥çŸ¥é“çš„ 3 ä¸ªæ’ç‰ˆåŸåˆ™](https://mp.weixin.qq.com/s/9RotXR2VyBtCNhD5borBrw)

## 30 seconds of code

### ç›®æ ‡

ç¼–å†™ä¸€ä¸ª JavaScript å‡½æ•° uniqueNumsï¼Œè¯¥å‡½æ•°æœ‰ä¸€ä¸ªå‚æ•° nï¼ˆä¸€ä¸ªä¸å¤§ 31 çš„æ•´æ•°ï¼‰ï¼Œå…¶è¿”å›å€¼æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¯¥æ•°ç»„å†…æ˜¯ n ä¸ªéšæœºä¸”ä¸é‡å¤çš„æ•´æ•°ï¼Œä¸”æ•´æ•°å–å€¼èŒƒå›´æ˜¯ [2, 32]ã€‚

### æ ·ä¾‹è¾“å‡º:

```js
uniqueNums(10) // [9, 22, 4, 24, 23, 8, 14, 26, 19, 28]
```

### å‚è€ƒå®ç°

```js
const uniqueNums = (n) =>
  Array.from({ length: 31 }, (_, b) => b + 2)
    .sort((v) => Math.random() - 0.5)
    .slice(0, n)
```

## æ¯æ—¥ä¸€é—®

> æŸå…¬å¸ 1 åˆ° 12 æœˆä»½çš„é”€å”®é¢å­˜åœ¨ä¸€ä¸ªå¯¹è±¡é‡Œé¢ï¼Œå¦‚ä¸‹ï¼š`{1:222, 2:123, 5:888}`ï¼Œè¯·æŠŠæ•°æ®å¤„ç†ä¸ºå¦‚ä¸‹ç»“æ„ï¼š`[222, 123, null, null, 888, null, null, null, null, null, null, null]`

## æ¯æ—¥äºŒé—®

> ä»¥ä¸‹ä»£ç çš„è¿è¡Œç»“æœä¸º

```js
var a = { n: 1 }
var b = a
a.x = a = { n: 2 }

console.log(a.x)
console.log(b.x)
```

### ä¸ŠæœŸçš„ç­”æ¡ˆ

#### ç¬¬ä¸€é¢˜

> ä»¥ä¸‹ä»£ç çš„è¿è¡Œç»“æœä¸º

```js
;[1 < 2 < 3, 3 < 2 < 1]
```

- ç­”æ¡ˆï¼š[true,true]
- è§£æï¼š 1 < 2 => true;
  true < 3 => 1 < 3 => true;
  3 < 2 => false;
  false < 1 => 0 < 1 => true;

#### ç¬¬äºŒé¢˜

> ä»¥ä¸‹ä»£ç çš„è¿è¡Œç»“æœä¸º

```js
var a = { class: 'Animal', name: 'Fido' }
a.class
```

- ç­”æ¡ˆï¼šother
- è§£æï¼šè¿™å–å†³äºæµè§ˆå™¨ã€‚ç±»æ˜¯ä¸€ä¸ªä¿ç•™å­—ï¼Œä½†æ˜¯å®ƒè¢« Chromeã€Firefox å’Œ Opera æ¥å—ä¸ºå±æ€§åã€‚åœ¨å¦ä¸€æ–¹é¢ï¼Œæ¯ä¸ªäººéƒ½ä¼šæ¥å—å¤§å¤šæ•°å…¶ä»–ä¿ç•™è¯ï¼ˆintï¼Œç§æœ‰ï¼ŒæŠ›å‡ºç­‰ï¼‰ä½œä¸ºå˜é‡åï¼Œè€Œç±»æ˜¯ VordBointã€‚
