---
title: ç¬¬142æœŸ
date: '2022-07-23'
tags: ['eslint', 'project', 'æ„å»º']
draft: false
summary: æµ…æ eslint åŸç†;å‰ç«¯æ„å»ºæ•ˆç‡ä¼˜åŒ–ä¹‹è·¯
---

<TOCInline toc={props.toc} asDisclosure toHeading={3} />

## 2022/07/23

## æ¯å‘¨èµ„è®¯ - ç¬¬`142`æœŸ

### æµ…æ eslint åŸç†

åœ¨å‰ç«¯å¼€å‘è¿‡ç¨‹ä¸­ï¼Œeslint è§„èŒƒå·²ç»æˆä¸ºå¿…ä¸å¯å°‘çš„ä¸€ç¯ï¼Œæˆ‘ä»¬éœ€è¦ eslint æ¥ä¿è¯ä»£ç è§„èŒƒï¼Œç›¸å¯¹ç»Ÿä¸€åŒå­¦ä»¬çš„ä»£ç é£æ ¼ï¼Œä¸ç„¶å°±ä¼šå‡ºç°æ‰€æœ‰åŒå­¦éƒ½éšæ„å¼•å…¥è‡ªå·±åå¥½çš„é£æ ¼æˆ–è€…è§„èŒƒï¼Œè®©æ‰€æœ‰äººä¸€èµ·åˆ†æ‹…å¼•å…¥è§„èŒƒçš„ä»£ä»·ã€‚

åŒæ—¶ï¼Œæœ‰äº› lint è§„åˆ™å¯ä»¥é¿å… bug çš„äº§ç”Ÿï¼Œåœ¨æé«˜ä»£ç å¯è¯»æ€§çš„å‰æä¸‹ï¼Œå‡å°‘é—®é¢˜æ•°é‡ï¼Œå°†é—®é¢˜æ›´å¤šçš„æš´éœ²åœ¨å¼€å‘é˜¶æ®µã€‚

##### ä¸€ã€eslint çš„è§„åˆ™

è¯´èµ· eslintï¼Œç¬¬ä¸€æƒ³åˆ°çš„å°±æ˜¯ eslints é‡Œé¢çš„æ¯æ¡è§„åˆ™ï¼Œæˆ‘ä»¬é€šè¿‡ä»¥ä¸‹ç®€å•çš„é…ç½®å°±å¯ä»¥æ¥æ§åˆ¶è§„åˆ™çš„å¼€å¯åŠå…³é—­ã€‚å…¶ä¸­ï¼š0 1 2 åˆ†åˆ«å¯¹åº” 'off' 'warn' 'error';å¦‚æœæ˜¯ä¸ªæ•°ç»„ï¼Œç¬¬äºŒä¸ªå‚æ•°å¯ä»¥è‡ªå®šä¹‰é…ç½®ã€‚

```json
{
  "rules": {
    "arrow-body-style": 0, // 0 1 2
    "quotes": ["error", "single"]
  }
}
```

å…¶ä¸­ rules çš„æ¯ä¸€ä¸ª key å°±æ˜¯å¯¹åº”çš„ä¸€æ¡è§„åˆ™ï¼Œé€è¿‡ä½¿ç”¨å»æ€è€ƒï¼Œeslint å¦‚ä½•å»å®ç°çš„è¿™æ¡è§„åˆ™å‘¢ï¼ŸğŸ¤”

##### eslint çš„æ ¸å¿ƒ rules

eslint çš„æ ¸å¿ƒå°±æ˜¯ rulesï¼Œç†è§£ä¸€ä¸ª rule çš„ç»“æ„å¯¹äºç†è§£ eslint çš„åŸç†å’Œåˆ›å»ºè‡ªå®šä¹‰è§„åˆ™éå¸¸é‡è¦ã€‚

æˆ‘ä»¬çœ‹ä¸€ä¸‹è‡ªå®šä¹‰[eslint è§„åˆ™](https://eslint.bootcss.com/docs/developer-guide/working-with-rules) å†ç»“åˆç›®å‰å·²æœ‰çš„æŸæ¡è§„åˆ™æ¥åˆ†æ

çœ‹ä¸€ä¸‹æœ€ç®€å•çš„ä¸€æ¡è§„åˆ™ no-with

```js
module.exports = {
  meta: {
    // åŒ…å«è§„åˆ™çš„å…ƒæ•°æ®
    // æŒ‡ç¤ºè§„åˆ™çš„ç±»å‹ï¼Œå€¼ä¸º "problem"ã€"suggestion" æˆ– "layout"
    type: 'suggestion',

    docs: {
      // å¯¹ ESLint æ ¸å¿ƒè§„åˆ™æ¥è¯´æ˜¯å¿…éœ€çš„
      description: 'disallow `with` statements', // æä¾›è§„åˆ™çš„ç®€çŸ­æè¿°åœ¨è§„åˆ™é¦–é¡µå±•ç¤º
      // category (string) æŒ‡å®šè§„åˆ™åœ¨è§„åˆ™é¦–é¡µå¤„äºçš„åˆ†ç±»
      recommended: true, // é…ç½®æ–‡ä»¶ä¸­çš„ "extends": "eslint:recommended"å±æ€§æ˜¯å¦å¯ç”¨è¯¥è§„åˆ™
      url: 'https://eslint.org/docs/rules/no-with', // æŒ‡å®šå¯ä»¥è®¿é—®å®Œæ•´æ–‡æ¡£çš„ url
    },

    // fixable å¦‚æœæ²¡æœ‰ fixable å±æ€§ï¼Œå³ä½¿è§„åˆ™å®ç°äº† fix åŠŸèƒ½ï¼ŒESLint ä¹Ÿä¸ä¼šè¿›è¡Œä¿®å¤ã€‚å¦‚æœè§„åˆ™ä¸æ˜¯å¯ä¿®å¤çš„ï¼Œå°±çœç•¥ fixable å±æ€§ã€‚

    schema: [], // æŒ‡å®šè¯¥é€‰é¡¹ è¿™æ ·çš„ ESLint å¯ä»¥é¿å…æ— æ•ˆçš„è§„åˆ™é…ç½®

    // deprecated (boolean) è¡¨æ˜è§„åˆ™æ˜¯å·²è¢«å¼ƒç”¨ã€‚å¦‚æœè§„åˆ™å°šæœªè¢«å¼ƒç”¨ï¼Œä½ å¯ä»¥çœç•¥ deprecated å±æ€§ã€‚

    messages: {
      unexpectedWith: "Unexpected use of 'with' statement.",
    },
  },
  // create (function) è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«äº† ESLint åœ¨éå† js ä»£ç çš„æŠ½è±¡è¯­æ³•æ ‘ AST (ESTree å®šä¹‰çš„ AST) æ—¶ï¼Œç”¨æ¥è®¿é—®èŠ‚ç‚¹çš„æ–¹æ³•ã€‚
  create(context) {
    // å¦‚æœä¸€ä¸ª key æ˜¯ä¸ªèŠ‚ç‚¹ç±»å‹æˆ– selectorï¼Œåœ¨ å‘ä¸‹ éå†æ ‘æ—¶ï¼ŒESLint è°ƒç”¨ visitor å‡½æ•°
    // å¦‚æœä¸€ä¸ª key æ˜¯ä¸ªèŠ‚ç‚¹ç±»å‹æˆ– selectorï¼Œå¹¶å¸¦æœ‰ :exitï¼Œåœ¨ å‘ä¸Š éå†æ ‘æ—¶ï¼ŒESLint è°ƒç”¨ visitor å‡½æ•°
    // å¦‚æœä¸€ä¸ª key æ˜¯ä¸ªäº‹ä»¶åå­—ï¼ŒESLint ä¸ºä»£ç è·¯å¾„åˆ†æè°ƒç”¨ handler å‡½æ•°
    // selector ç±»å‹å¯ä»¥åˆ° estree æŸ¥æ‰¾
    return {
      // å…¥å‚ä¸ºèŠ‚ç‚¹node
      WithStatement(node) {
        context.report({ node, messageId: 'unexpectedWith' })
      },
    }
  },
}
```

æœ‰ä¸¤éƒ¨åˆ†ç»„æˆï¼šmeta createï¼›

- metaï¼šï¼ˆå¯¹è±¡ï¼‰åŒ…å«è§„åˆ™çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬ è§„åˆ™çš„ç±»å‹ï¼Œæ–‡æ¡£ï¼Œæ˜¯å¦æ¨èè§„åˆ™ï¼Œæ˜¯å¦å¯ä¿®å¤ç­‰ä¿¡æ¯ï¼›
- createï¼šï¼ˆå‡½æ•°ï¼‰è¿”å›ä¸€ä¸ªå¯¹è±¡å…¶ä¸­åŒ…å«äº† ESLint åœ¨éå† JavaScript ä»£ç çš„æŠ½è±¡è¯­æ³•æ ‘ AST ([ESTree](https://github.com/estree/estree) å®šä¹‰çš„ AST) æ—¶ï¼Œç”¨æ¥è®¿é—®èŠ‚ç‚¹çš„æ–¹æ³•ï¼Œå…¥å‚ä¸ºè¯¥èŠ‚ç‚¹ã€‚
  - å¦‚æœä¸€ä¸ª key æ˜¯ä¸ªèŠ‚ç‚¹ç±»å‹æˆ– [selector](https://eslint.bootcss.com/docs/developer-guide/selectors)ï¼Œåœ¨ å‘ä¸‹ éå†æ ‘æ—¶ï¼ŒESLint è°ƒç”¨ visitor å‡½æ•°
  - å¦‚æœä¸€ä¸ª key æ˜¯ä¸ªèŠ‚ç‚¹ç±»å‹æˆ– [selector](https://eslint.bootcss.com/docs/developer-guide/selectors)ï¼Œå¹¶å¸¦æœ‰ :exitï¼Œåœ¨ å‘ä¸Š éå†æ ‘æ—¶ï¼ŒESLint è°ƒç”¨ visitor å‡½æ•°
  - å¦‚æœä¸€ä¸ª key æ˜¯ä¸ªäº‹ä»¶åå­—ï¼Œ[ESLint ä¸ºä»£ç è·¯å¾„åˆ†æ](https://eslint.bootcss.com/docs/developer-guide/code-path-analysis)è°ƒç”¨ handler å‡½æ•°

#### äºŒã€eslint å‘½ä»¤çš„æ‰§è¡Œ

åœ¨ package.json é‡Œé…ç½® bin

```json
"bin": {
  "eslint": "bin/eslint.js" // å‘Šè¯‰ npm ä½ çš„å‘½ä»¤æ˜¯ä»€ä¹ˆ
}
```

ç„¶ååˆ›å»ºå¯¹åº”çš„æ–‡ä»¶

```bash
# !/usr/bin/env node
console.log("console.log output")
```

è¿™å°±æ˜¯ eslint å‘½ä»¤è¡Œçš„å…¥å£

```js
;(async function main() {
  // ç›‘å¬å¼‚å¸¸å¤„ç†
  process.on('uncaughtException', onFatalError)
  process.on('unhandledRejection', onFatalError)

  // å¦‚æœå‚æ•°æœ‰ --init å°±æ‰§è¡Œåˆå§‹åŒ–
  if (process.argv.includes('--init')) {
    await require('../lib/init/config-initializer').initializeConfig()
    return
  }

  // å¦åˆ™å°±æ‰§è¡Œ æ£€æŸ¥ä»£ç çš„ä»£ç 
  process.exitCode = await require('../lib/cli').execute(
    process.argv,
    process.argv.includes('--stdin') ? await readStdin() : null
  )
})().catch(onFatalError)
```

ä»£ç æ£€æŸ¥çš„å‡½æ•°æ˜¯ ** cli.execute() **ä» lib ä¸­å¼•å…¥çš„ cli å¯¹è±¡ã€‚

#### ä¸‰ã€eslint æ‰§è¡Œçš„è°ƒç”¨æ ˆ

##### execute() å‡½æ•°

è¿™æ˜¯ eslint çš„ä¸»è¦ä»£ç æ‰§è¡Œé€»è¾‘ï¼Œä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š

1. è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œæ ¡éªŒå‚æ•°æ­£ç¡®ä¸å¦åŠæ‰“å°ç›¸å…³ä¿¡æ¯ï¼›
2. åˆå§‹åŒ– æ ¹æ®é…ç½®å®ä¾‹ä¸€ä¸ª engine å¯¹è±¡ CLIEngine å®ä¾‹ï¼›
3. engine.executeOnFiles è¯»å–æºä»£ç è¿›è¡Œæ£€æŸ¥ï¼Œè¿”å›æŠ¥é”™ä¿¡æ¯å’Œä¿®å¤ç»“æœã€‚

```js
execute(args, text) {
    if (Array.isArray(args)) {
        debug("CLI args: %o", args.slice(2));
    }
    let currentOptions;
    try {
    // å…ˆæ ¡éªŒå‚æ•° å¦‚æœè¾“å…¥ --halp æç¤º --helpï¼Œå¹¶é€šè¿‡optionsçš„é…ç½®ç»™é»˜è®¤å€¼
        currentOptions = options.parse(args);
    } catch (error) {
        log.error(error.message);
        return 2;
    }

    const files = currentOptions._;
    const useStdin = typeof text === "string";

    // ---çœç•¥å¾ˆå¤š---å‚æ•°æ ¡éªŒåŠè¾“å‡º
    // ...
    // æ ¹æ®é…ç½®å®ä¾‹ä¸€ä¸ªengineå¯¹è±¡
    const engine = new CLIEngine(translateOptions(currentOptions));
    // report å°±æ˜¯æœ€åçš„ç»“æœ
    const report = useStdin ? engine.executeOnText(text, currentOptions.stdinFilename, true) : engine.executeOnFiles(files);
    // ...
    // ---çœç•¥å¾ˆå¤š---å‚æ•°æ ¡éªŒåŠè¾“å‡º

    return 0;
}
```

å¯ä»¥çœ‹åˆ° eslint å°±æ˜¯åœ¨æ‰§è¡Œ engine.executeOnFiles(files) ä¹‹åè·å¾—æ£€æŸ¥çš„ç»“æœ

##### executeOnFiles (files) å‡½æ•°

å¯ä»¥çœ‹åˆ° eslint å°±æ˜¯åœ¨æ‰§è¡Œ engine.executeOnFiles(files) ä¹‹åè·å¾—æ£€æŸ¥çš„ç»“æœï¼›è¯¥å‡½æ•°ä¸»è¦ä½œç”¨æ˜¯å¯¹ä¸€ç»„æ–‡ä»¶å’Œç›®å½•åç§°æ‰§è¡Œå½“å‰é…ç½®ã€‚

ç®€å•çœ‹ä¸€ä¸‹ executeOnFile s ()

è¯¥å‡½æ•°è¾“å…¥æ–‡ä»¶ç›®å½•ï¼Œè¿”å› lint ä¹‹åçš„ç»“æœ

ä¸»è¦æ‰§è¡Œé€»è¾‘å¦‚ä¸‹ï¼š

1. fileEnumerator ç±»ï¼Œè¿­ä»£æ‰€æœ‰çš„æ–‡ä»¶è·¯å¾„åŠä¿¡æ¯ï¼›
2. æ£€æŸ¥æ˜¯å¦å¿½ç•¥çš„æ–‡ä»¶ï¼Œlint ç¼“å­˜ ç­‰ç­‰ä¸€å †æ“ä½œï¼›
3. è°ƒç”¨ verifyText() å‡½æ•°æ‰§è¡Œæ£€æŸ¥
4. å‚¨å­˜ lint ä¹‹åçš„ç»“æœ

```js
/**
 * Executes the current configuration on an array of file and directory names.
 * @param {string[]} patterns An array of file and directory names.
 * @returns {LintReport} The results for all files that were linted.
 */
executeOnFiles(patterns) {
    // .....
    // fileEnumerator ç±»ï¼Œè¿­ä»£æ‰€æœ‰çš„æ–‡ä»¶è·¯å¾„åŠä¿¡æ¯
    for (const { config, filePath, ignored } of fileEnumerator.iterateFiles(patterns)) {

    // ....... æ£€æŸ¥æ˜¯å¦å¿½ç•¥çš„æ–‡ä»¶ï¼Œç¼“å­˜ ç­‰ç­‰ä¸€å †æ“ä½œ

        // Do lint.
        const result = verifyText({
            text: fs.readFileSync(filePath, "utf8"),
            filePath,
            config,
            cwd,
            fix,
            allowInlineConfig,
            reportUnusedDisableDirectives,
            extensionRegExp: fileEnumerator.extensionRegExp,
            linter
        });

        results.push(result);

        /*
         * Store the lint result in the LintResultCache.
         * NOTE: The LintResultCache will remove the file source and any
         * other properties that are difficult to serialize, and will
         * hydrate those properties back in on future lint runs.
         */
        if (lintResultCache) {
            lintResultCache.setCachedLintResults(filePath, config, result);
        }
    }
}
```

##### verifyText() å‡½æ•°

å…¶å®å°±æ˜¯è°ƒç”¨äº† linter.verifyAndFix() å‡½æ•°

##### verifyAndFix() å‡½æ•°

è¿™ä¸ªå‡½æ•°æ˜¯æ ¸å¿ƒå‡½æ•°ï¼Œé¡¾åæ€ä¹‰ verify & fix

ä»£ç æ ¸å¿ƒå¤„ç†é€»è¾‘æ˜¯é€šè¿‡ä¸€ä¸ª do while å¾ªç¯æ§åˆ¶ï¼›ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ä¼šæ‰“æ–­å¾ªç¯

1. æ²¡æœ‰æ›´å¤šå¯ä»¥è¢« fix çš„ä»£ç äº†
2. å¾ªç¯è¶…è¿‡åæ¬¡
3. å…¶ä¸­ verify å‡½æ•°å¯¹æºä»£ç æ–‡ä»¶è¿›è¡Œä»£ç æ£€æŸ¥ï¼Œä»è§„åˆ™ç»´åº¦è¿”å›æ£€æŸ¥ç»“æœæ•°ç»„
4. applyFixes å‡½æ•°æ‹¿åˆ°ä¸Šä¸€æ­¥çš„è¿”å›ï¼Œå» fix ä»£ç 
5. å¦‚æœè®¾ç½®äº†å¯ä»¥ fixï¼Œé‚£ä¹ˆä½¿ç”¨ fix ä¹‹åçš„ç»“æœ ä»£æ›¿åŸæœ¬çš„ text

```js
/**
 * This loop continues until one of the following is true:
 *
 * 1. No more fixes have been applied.
 * 2. Ten passes have been made.
 * That means anytime a fix is successfully applied, there will be another pass.
 * Essentially, guaranteeing a minimum of two passes.
 */
do {
  passNumber++ // åˆå§‹å€¼0
  // è¿™ä¸ªå‡½æ•°å°±æ˜¯ verify  åœ¨ verify è¿‡ç¨‹ä¸­ä¼šæŠŠä»£ç è½¬æ¢æˆast
  debug(`Linting code for ${debugTextDescription} (pass ${passNumber})`)
  messages = this.verify(currentText, config, options)
  // è¿™ä¸ªå‡½æ•°å°±æ˜¯ fix
  debug(`Generating fixed text for ${debugTextDescription} (pass ${passNumber})`)
  fixedResult = SourceCodeFixer.applyFixes(currentText, messages, shouldFix)

  /*
   * å¦‚æœæœ‰ syntax errors å°± break.
   * 'fixedResult.output' is a empty string.
   */
  if (messages.length === 1 && messages[0].fatal) {
    break
  }

  // keep track if any fixes were ever applied - important for return value
  fixed = fixed || fixedResult.fixed

  // ä½¿ç”¨fixä¹‹åçš„ç»“æœ ä»£æ›¿åŸæœ¬çš„text
  currentText = fixedResult.output
} while (
  fixedResult.fixed &&
  passNumber < MAX_AUTOFIX_PASSES // 10
)
```

åœ¨ verify è¿‡ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨ parse å‡½æ•°ï¼ŒæŠŠä»£ç è½¬æ¢æˆ AST

```js
// é»˜è®¤çš„astè§£ææ˜¯espree
const espree = require('espree')

let parserName = DEFAULT_PARSER_NAME // 'espree'
let parser = espree
```

parse å‡½æ•°ä¼šè¿”å›ä¸¤ç§ç»“æœ

- `{success: false, error: Problem}` è§£æ AST æˆåŠŸ
- `{success: true, sourceCode: SourceCode}` è§£æ AST å¤±è´¥

##### æœ€ç»ˆä¼šè°ƒç”¨ runRules() å‡½æ•°

è¿™ä¸ªå‡½æ•°æ˜¯ä»£ç æ£€æŸ¥å’Œä¿®å¤çš„æ ¸å¿ƒæ–¹æ³•ï¼Œä¼šå¯¹ä»£ç è¿›è¡Œè§„åˆ™æ ¡éªŒã€‚

1. åˆ›å»ºä¸€ä¸ª eventEmitter å®ä¾‹ã€‚æ˜¯ eslint è‡ªå·±å®ç°çš„å¾ˆç®€å•çš„ä¸€ä¸ªäº‹ä»¶è§¦å‘ç±» on ç›‘å¬ emit è§¦å‘ï¼›
2. é€’å½’éå† ASTï¼Œæ·±åº¦ä¼˜å…ˆæœç´¢ï¼ŒæŠŠèŠ‚ç‚¹æ·»åŠ åˆ° nodeQueueã€‚ä¸€ä¸ª node æ”¾å…¥ä¸¤æ¬¡ï¼Œç±»ä¼¼äº`A->B->C->...->C->B->A`ï¼›
3. éå† rulesï¼Œè°ƒç”¨ rule.create()ï¼ˆrules ä¸­æåˆ°çš„ meta å’Œ create å‡½æ•°ï¼‰ æ‹¿åˆ°äº‹ä»¶(selector)æ˜ å°„è¡¨ï¼Œæ·»åŠ äº‹ä»¶ç›‘å¬ã€‚
4. åŒ…è£…ä¸€ä¸ª ruleContext å¯¹è±¡ï¼Œä¼šé€šè¿‡å‚æ•°ï¼Œä¼ ç»™ rule.create()ï¼Œå…¶ä¸­åŒ…å« report() å‡½æ•°ï¼Œæ¯ä¸ª rule çš„ handler éƒ½ä¼šæ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼ŒæŠ›å‡ºé—®é¢˜ï¼›
5. è°ƒç”¨ rule.create(ruleContext)ï¼Œ éå†å…¶è¿”å›çš„å¯¹è±¡ï¼Œæ·»åŠ äº‹ä»¶ç›‘å¬ï¼›ï¼ˆå¦‚æœéœ€è¦ lint è®¡æ—¶ï¼Œåˆ™è°ƒç”¨ process.hrtime()è®¡æ—¶ï¼‰ï¼›
6. éå† nodeQueueï¼Œè§¦å‘å½“å‰èŠ‚ç‚¹äº‹ä»¶çš„å›è°ƒï¼Œè°ƒç”¨ NodeEventGenerator å®ä¾‹é‡Œé¢çš„å‡½æ•°ï¼Œè§¦å‘ emitter.emit()ã€‚

```js
// 1. åˆ›å»ºä¸€ä¸ª eventEmitter å®ä¾‹ã€‚æ˜¯eslintè‡ªå·±å®ç°çš„å¾ˆç®€å•çš„ä¸€ä¸ªäº‹ä»¶è§¦å‘ç±» onç›‘å¬ emitè§¦å‘
const emitter = createEmitter()

// 2. é€’å½’éå† ASTï¼ŒæŠŠèŠ‚ç‚¹æ·»åŠ åˆ° nodeQueueã€‚ä¸€ä¸ªnodeæ”¾å…¥ä¸¤æ¬¡ A->B->C->...->C->B->A
Traverser.traverse(sourceCode.ast, {
  enter(node, parent) {
    node.parent = parent
    nodeQueue.push({ isEntering: true, node })
  },
  leave(node) {
    nodeQueue.push({ isEntering: false, node })
  },
  visitorKeys: sourceCode.visitorKeys,
})

// 3. éå† rulesï¼Œè°ƒç”¨ rule.create() æ‹¿åˆ°äº‹ä»¶(selector)æ˜ å°„è¡¨ï¼Œæ·»åŠ äº‹ä»¶ç›‘å¬ã€‚
// ï¼ˆè¿™é‡Œçš„ configuredRules æ˜¯æˆ‘ä»¬åœ¨ .eslintrc.json è®¾ç½®çš„ rulesï¼‰
Object.keys(configuredRules).forEach((ruleId) => {
  const severity = ConfigOps.getRuleSeverity(configuredRules[ruleId])

  // é€šè¿‡ruleIdæ‹¿åˆ°æ¯ä¸ªè§„åˆ™å¯¹åº”çš„ä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢æœ‰ä¸¤éƒ¨åˆ† meta & create è§ ã€ç¼–å†™ruleã€‘
  const rule = ruleMapper(ruleId)

  // ....

  const messageIds = rule.meta && rule.meta.messages
  let reportTranslator = null
  // è¿™ä¸ªå¯¹è±¡æ¯”è¾ƒé‡è¦ï¼Œä¼šä¼ ç»™ æ¯ä¸ªè§„åˆ™é‡Œçš„ rule.createå‡½æ•°
  const ruleContext = Object.freeze(
    Object.assign(Object.create(sharedTraversalContext), {
      id: ruleId,
      options: getRuleOptions(configuredRules[ruleId]),
      // æ¯ä¸ªruleçš„ handler éƒ½ä¼šæ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼ŒæŠ›å‡ºé—®é¢˜
      report(...args) {
        if (reportTranslator === null) {
          reportTranslator = createReportTranslator({
            ruleId,
            severity,
            sourceCode,
            messageIds,
            disableFixes,
          })
        }
        const problem = reportTranslator(...args)
        // çœç•¥ä¸€å †é”™è¯¯æ ¡éªŒ
        // ....
        // çœç•¥ä¸€å †é”™è¯¯æ ¡éªŒ

        // lintçš„ç»“æœ
        lintingProblems.push(problem)
      },
    })
  )
  // åŒ…è£…äº†ä¸€ä¸‹ï¼Œå…¶å®å°±æ˜¯ æ‰§è¡Œ rule.create(ruleContext);
  // rule.create(ruleContext) ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œkeyå°±æ˜¯äº‹ä»¶åç§°
  const ruleListeners = createRuleListeners(rule, ruleContext)

  /**
   * åœ¨é”™è¯¯ä¿¡æ¯ä¸­åŠ å…¥ruleId
   * @param {Function} ruleListener ç›‘å¬åˆ°æ¯ä¸ªnodeï¼Œç„¶åå¯¹åº”çš„æ–¹æ³•rule.create(ruleContext)è¿”å›çš„å¯¹è±¡ä¸­å¯¹åº”keyçš„value
   * @returns {Function} ruleListener wrapped in error handler
   */
  function addRuleErrorHandler(ruleListener) {
    return function ruleErrorHandler(...listenerArgs) {
      try {
        return ruleListener(...listenerArgs)
      } catch (e) {
        e.ruleId = ruleId
        throw e
      }
    }
  }

  // éå† rule.create(ruleContext) è¿”å›çš„å¯¹è±¡ï¼Œæ·»åŠ äº‹ä»¶ç›‘å¬
  Object.keys(ruleListeners).forEach((selector) => {
    const ruleListener = timing.enabled
      ? timing.time(ruleId, ruleListeners[selector]) // è°ƒç”¨process.hrtime()è®¡æ—¶
      : ruleListeners[selector]
    // å¯¹æ¯ä¸€ä¸ª selector è¿›è¡Œç›‘å¬ï¼Œæ·»åŠ  callback
    emitter.on(selector, addRuleErrorHandler(ruleListener))
  })
})

// åªæœ‰é¡¶å±‚nodeç±»å‹æ˜¯Programæ‰è¿›è¡Œä»£ç è·¯å¾„åˆ†æ
const eventGenerator =
  nodeQueue[0].node.type === 'Program'
    ? new CodePathAnalyzer(
        new NodeEventGenerator(emitter, {
          visitorKeys: sourceCode.visitorKeys,
          fallback: Traverser.getKeys,
        })
      )
    : new NodeEventGenerator(emitter, {
        visitorKeys: sourceCode.visitorKeys,
        fallback: Traverser.getKeys,
      })

// 4. éå† nodeQueueï¼Œè§¦å‘å½“å‰èŠ‚ç‚¹äº‹ä»¶çš„å›è°ƒã€‚
// è¿™ä¸ª nodeQueue æ˜¯å‰é¢pushè¿›æ‰€æœ‰çš„nodeï¼Œåˆ†ä¸º å…¥å£ å’Œ ç¦»å¼€
nodeQueue.forEach((traversalInfo) => {
  currentNode = traversalInfo.node
  try {
    if (traversalInfo.isEntering) {
      // è°ƒç”¨ NodeEventGenerator å®ä¾‹é‡Œé¢çš„å‡½æ•°
      // åœ¨è¿™é‡Œè§¦å‘ emitter.emit()
      eventGenerator.enterNode(currentNode)
    } else {
      eventGenerator.leaveNode(currentNode)
    }
  } catch (err) {
    err.currentNode = currentNode
    throw err
  }
})
// lintçš„ç»“æœ
return lintingProblems
```

#### å››ã€æ€»ä½“è¿è¡Œæœºåˆ¶

æ¦‚æ‹¬æ¥è¯´å°±æ˜¯ï¼ŒESLint ä¼šéå†å‰é¢è¯´åˆ°çš„ ASTï¼Œç„¶ååœ¨éå†åˆ°ã€Œä¸åŒçš„èŠ‚ç‚¹ã€æˆ–è€…ã€Œç‰¹å®šçš„æ—¶æœºã€çš„æ—¶å€™ï¼Œè§¦å‘ç›¸åº”çš„å¤„ç†å‡½æ•°ï¼Œç„¶ååœ¨å‡½æ•°ä¸­ï¼Œå¯ä»¥æŠ›å‡ºé”™è¯¯ï¼Œç»™å‡ºæç¤ºã€‚
![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/42f892f36718430b9fbb942b0b22dd0e~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

##### Tips: espree éœ€è¦æ›´æ¢è§£æå™¨

é—®é¢˜ï¼šespree æ— æ³•è¯†åˆ« TypeScript çš„ä¸€äº›è¯­æ³•ï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­çš„ .eslintrc.json é‡Œæ‰è¦é…ç½®

```json
{
  "parser": "@typescript-eslint/parser"
}
```

ç»™ eslint æŒ‡å®šè§£æå™¨ï¼Œæ›¿ä»£æ‰é»˜è®¤çš„è§£æå™¨ã€‚

eslint ä¸­æ¶‰åŠåˆ°è§„åˆ™çš„æ ¡éªŒæºç è°ƒç”¨æ ˆå¤§è‡´å°±å¦‚ä¸Šåˆ†æï¼Œä½†å…¶å® eslint è¿œä¸æ­¢è¿™äº›ï¼Œè¿˜æœ‰å¾ˆå¤šå¯ä»¥å€¼å¾—å­¦ä¹ çš„ç‚¹ï¼Œå¦‚ï¼šè¿­ä»£æ–‡ä»¶è·¯å¾„ã€fix ä¿®å¤æ–‡æœ¬ã€æŠ¥å‘Šé”™è¯¯åŠè‡ªå®šä¹‰æ ¼å¼ç­‰ç­‰ï¼Œæ¬¢è¿æ„Ÿå…´è¶£çš„åŒå­¦ä¸€èµ·è®¨è®ºäº¤æµï¼Œä¹Ÿæ¬¢è¿åŒå­¦æ‰¹è¯„æŒ‡æ­£ï½

#### æ¥æº

- [æµ…æ eslint åŸç†](https://mp.weixin.qq.com/s/45-itfERV4R77WS0JL_Oew)

### 2. å‰ç«¯æ„å»ºæ•ˆç‡ä¼˜åŒ–ä¹‹è·¯

#### æ¥æº

- [å‰ç«¯æ„å»ºæ•ˆç‡ä¼˜åŒ–ä¹‹è·¯](https://mp.weixin.qq.com/s/ORqdfZZ8qFyJdYTRwEULgQ)
